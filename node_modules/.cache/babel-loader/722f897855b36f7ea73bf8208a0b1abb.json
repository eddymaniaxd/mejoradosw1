{"ast":null,"code":"var _jsxFileName = \"C:\\\\sw1\\\\FDiagramaC4-master\\\\src\\\\page\\\\board\\\\BoardPage.js\",\n    _s = $RefreshSig$();\n\nimport React, { useCallback, useContext, useEffect, useRef, useState } from 'react';\nimport { useHistory } from 'react-router-dom';\nimport pako from 'pako';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { faBars } from '@fortawesome/free-solid-svg-icons';\nimport Sidebar from '../../components/Sidebar';\nimport Modal from '../../components/Modal';\nimport { textEncode } from '../../helpers/helpers';\nimport { useSala } from '../../hooks/useSala';\nimport { apiDiagrama } from '../../api/apiDiagrama';\nimport socketContext from '../../context/socketContext';\nimport { useDiagrama } from '../../hooks/useDiagrama';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\n\nconst BoardPage = () => {\n  _s();\n\n  const history = useHistory();\n  const {\n    socket\n  } = useContext(socketContext);\n  const [showbar, setShowbar] = useState(false);\n  const [typeModal, setTypeModal] = useState(\"load\");\n  const [typeDiagram, settypeDiagram] = useState(\"Container\");\n  const {\n    executeDraw\n  } = useDiagrama();\n  const {\n    sala,\n    error,\n    isAnfitrion,\n    validate\n  } = useSala(); //Save DB\n\n  const [sourceDiagram, setsourceDiagram] = useState(\"\");\n  const [sourceRel, setSourceRel] = useState([]);\n  const refImage = useRef();\n\n  const HandleTypeModal = type => {\n    setTypeModal(type);\n  };\n\n  const HandleTypeDiagram = type => {\n    settypeDiagram(type);\n  };\n\n  const FinalizarRoom = async () => {\n    const res = await apiDiagrama(`/sala/finalize/${sala._id}`);\n\n    if (!res.ok) {\n      console.log(\"Error no se pudo cerrar la sala\");\n      return;\n    } // Finalizar sala\n\n\n    socket.emit(\"finalizar-sala\", {\n      idSala: sala._id\n    });\n    history.replace('/');\n  }; //Button Dowload\n\n\n  const HandleClickDowload = () => {\n    try {\n      fetch(refImage.current.src).then(resp => resp.blob()).then(blob => {\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.style.display = 'none';\n        a.href = url;\n        a.download = \"DiagramaC4\";\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url);\n      });\n    } catch (errr) {\n      alert(\"Nose pudo descargar la imagen!!!\");\n    }\n  }; //Button Borrar\n\n\n  const HandleBorraBoard = () => {\n    setsourceDiagram(\"\");\n    setSourceRel([]);\n    DrawDiagram();\n    socket.emit(\"borrar-board\", {\n      idSala: sala._id\n    });\n  };\n\n  const DrawDiagram = useCallback((element = \"\", SystemBoundary = null) => {\n    let source = `@startuml\\n!include C4_${typeDiagram}.puml\\n`;\n\n    if (SystemBoundary) {\n      const {\n        id,\n        title\n      } = SystemBoundary;\n      setsourceDiagram(sourceD => {\n        let DrawSystem_Boundary = `System_Boundary(${id},\"${title}\"){\\n` + sourceD + `}\\n`;\n        source += DrawSystem_Boundary;\n        source += \"@enduml\";\n        let data = textEncode(source);\n        let compressed = pako.deflate(data, {\n          level: 9,\n          to: 'string'\n        });\n        let result = btoa(compressed).replace(/\\+/g, '-').replace(/\\//g, '_');\n        refImage.current.src = `https://kroki.io/plantuml/svg/${result}`;\n        return DrawSystem_Boundary;\n      });\n      return;\n    }\n\n    setsourceDiagram(sourceD => {\n      source += sourceD;\n      source += element;\n      source += \"@enduml\";\n      let data = textEncode(source);\n      let compressed = pako.deflate(data, {\n        level: 9,\n        to: 'string'\n      });\n      let result = btoa(compressed).replace(/\\+/g, '-').replace(/\\//g, '_');\n      refImage.current.src = `https://kroki.io/plantuml/svg/${result}`;\n      return sourceD + element;\n    });\n  }, [typeDiagram]); // Save Data Board\n\n  const HandleSaveBoard = async () => {\n    const res = await apiDiagrama(`/sala/setData/${sala._id}`, \"POST\", {\n      board: sourceDiagram,\n      links: sourceRel\n    });\n\n    if (!res.ok) {\n      alert(\"No se pudo guardar la data !!!\");\n      return;\n    }\n\n    alert(\"Se guardo los datos de la pizarra !!!\");\n  }; // Solicitud Anfitrion [On]\n\n\n  useEffect(() => {\n    socket.on('solicitud-anfitrion', args => {\n      const {\n        idUser,\n        message,\n        idSala\n      } = args;\n\n      if (window.confirm(message)) {\n        socket.emit('solicitud-aceptada', {\n          idUser,\n          idSala\n        });\n      } else {\n        socket.emit('solicitud-denegada', {\n          idUser,\n          idSala\n        });\n      }\n    });\n    return () => {\n      socket.removeAllListeners(\"solicitud-anfitrion\");\n    };\n  }, [socket]); // Agregar ala sala join para que escuchen events [emit]\n\n  useEffect(() => {\n    sala && socket.emit('agregar-sala', {\n      idSala: sala._id\n    });\n  }, [socket, sala]); //Close Sala [On]\n\n  useEffect(() => {\n    socket.on('close-sala', args => {\n      socket.emit('leave-sala', args);\n      history.replace(\"/\");\n    });\n    return () => {\n      socket.removeAllListeners(\"close-sala\");\n    };\n  }, [socket, history]); //Borrar Board [On]\n\n  useEffect(() => {\n    socket.on(\"borrar-board-client\", () => {\n      setsourceDiagram(\"\");\n      setSourceRel([]);\n      DrawDiagram();\n    });\n    return () => {\n      socket.removeAllListeners(\"borrar-board-client\");\n    };\n  }, [socket, DrawDiagram]); // Draw Figure [On]\n\n  useEffect(() => {\n    socket.on(\"draw-figure-sala\", args => {\n      // params[0] :id\n      const {\n        element,\n        params,\n        idElement\n      } = args;\n\n      if (idElement) {\n        setSourceRel(rel => [...rel, idElement]);\n      }\n\n      if (element === \"DrawSystemBoundary\") {\n        const [id, title] = params;\n        DrawDiagram(\"\", {\n          id,\n          title\n        });\n        return;\n      }\n\n      DrawDiagram(executeDraw(element, params));\n    });\n    return () => {\n      socket.removeAllListeners(\"draw-figure-sala\");\n    };\n  }, [socket, executeDraw, DrawDiagram]); // Ejecuta cuado se cambia typeDiagram\n  // Se carga los datos guardados de la sala \n\n  useEffect(() => {\n    if (sala && refImage.current) {\n      setsourceDiagram(sala.board);\n      setSourceRel(sala.links);\n      DrawDiagram();\n    }\n  }, [sala, DrawDiagram]); // Eliminar element [On]\n\n  useEffect(() => {\n    socket.on(\"eliminar-element-client\", args => {\n      const {\n        idElement\n      } = args;\n      let regexFind = new RegExp(`\\\\S*${idElement}\\\\S*\\n`, \"gi\");\n      let regexCierre = new RegExp(`}\\n`, \"gi\");\n\n      if (idElement.includes('limit')) {\n        setsourceDiagram(dataSource => {\n          let res = dataSource.replace(regexFind, \"\");\n          res = res.replace(regexCierre, \"\");\n          return res;\n        });\n      } else {\n        setsourceDiagram(dataSource => {\n          let res = dataSource.replace(regexFind, \"\");\n          return res;\n        });\n      } // Eliminando id \n\n\n      setSourceRel(ArrayIds => {\n        let idFilters = ArrayIds.filter(idRel => idRel !== idElement);\n        return idFilters;\n      }); // Params por Defecto\n\n      DrawDiagram();\n    });\n    return () => {\n      socket.removeAllListeners(\"eliminar-element-client\");\n    };\n  }, [socket, DrawDiagram]);\n\n  if (validate) {\n    return /*#__PURE__*/_jsxDEV(\"h5\", {\n      className: \"text-center\",\n      children: \"Cargando !!!\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 283,\n      columnNumber: 16\n    }, this);\n  }\n\n  if (error.length > 0) {\n    return /*#__PURE__*/_jsxDEV(\"h5\", {\n      className: \"text-center\",\n      children: error\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 287,\n      columnNumber: 16\n    }, this);\n  }\n\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: [/*#__PURE__*/_jsxDEV(Sidebar, {\n      show: showbar,\n      HandleTypeModal: HandleTypeModal,\n      HandleTypeDiagram: HandleTypeDiagram\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 293,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"container-fluid\",\n      children: [/*#__PURE__*/_jsxDEV(\"header\", {\n        className: \"row border\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"col-md-11\",\n          children: /*#__PURE__*/_jsxDEV(\"h2\", {\n            className: \"text-center\",\n            children: \"C4 Diagramas\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 303,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 302,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"col-md-1 text-center my-auto\",\n          children: /*#__PURE__*/_jsxDEV(FontAwesomeIcon, {\n            icon: faBars,\n            className: \"pointer\",\n            onClick: () => setShowbar(!showbar)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 306,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 305,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 301,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"section\", {\n        className: \"row mt-3\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"col-12 col-md-10 mx-auto shadow board text-center\",\n          children: /*#__PURE__*/_jsxDEV(\"img\", {\n            ref: refImage,\n            src: \"x\",\n            alt: \"C4 diagramas\",\n            className: sourceRel.length > 2 ? \"h-100\" : \"\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 317,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 316,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"col-12 col-md-10 mx-auto p-2\",\n          children: isAnfitrion ? /*#__PURE__*/_jsxDEV(_Fragment, {\n            children: [/*#__PURE__*/_jsxDEV(\"button\", {\n              onClick: HandleSaveBoard,\n              className: \"btn btn-primary mx-1\",\n              children: \"Guardar\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 325,\n              columnNumber: 37\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              onClick: HandleBorraBoard,\n              className: \"btn btn-danger mx-1\",\n              children: \"Borrar\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 326,\n              columnNumber: 37\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              onClick: HandleClickDowload,\n              className: \"btn btn-success mx-1\",\n              children: \"Imprimir\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 327,\n              columnNumber: 37\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              onClick: FinalizarRoom,\n              className: \"btn btn-dark mx-1\",\n              children: \"Finalizar reunion\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 328,\n              columnNumber: 37\n            }, this)]\n          }, void 0, true) : /*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: HandleClickDowload,\n            className: \"btn btn-success mx-1\",\n            children: \"Imprimir\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 330,\n            columnNumber: 35\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 320,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 314,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(Modal, {\n        type: typeModal,\n        DrawDiagram: DrawDiagram,\n        setSourceRel: setSourceRel,\n        sourceRel: sourceRel,\n        setsourceDiagram: setsourceDiagram\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 336,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 299,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true);\n};\n\n_s(BoardPage, \"Y2ivg/vudyVJXZbSJEwuoVwyn8c=\", false, function () {\n  return [useHistory, useDiagrama, useSala];\n});\n\n_c = BoardPage;\nexport default BoardPage;\n\nvar _c;\n\n$RefreshReg$(_c, \"BoardPage\");","map":{"version":3,"sources":["C:/sw1/FDiagramaC4-master/src/page/board/BoardPage.js"],"names":["React","useCallback","useContext","useEffect","useRef","useState","useHistory","pako","FontAwesomeIcon","faBars","Sidebar","Modal","textEncode","useSala","apiDiagrama","socketContext","useDiagrama","BoardPage","history","socket","showbar","setShowbar","typeModal","setTypeModal","typeDiagram","settypeDiagram","executeDraw","sala","error","isAnfitrion","validate","sourceDiagram","setsourceDiagram","sourceRel","setSourceRel","refImage","HandleTypeModal","type","HandleTypeDiagram","FinalizarRoom","res","_id","ok","console","log","emit","idSala","replace","HandleClickDowload","fetch","current","src","then","resp","blob","url","window","URL","createObjectURL","a","document","createElement","style","display","href","download","body","appendChild","click","revokeObjectURL","errr","alert","HandleBorraBoard","DrawDiagram","element","SystemBoundary","source","id","title","sourceD","DrawSystem_Boundary","data","compressed","deflate","level","to","result","btoa","HandleSaveBoard","board","links","on","args","idUser","message","confirm","removeAllListeners","params","idElement","rel","regexFind","RegExp","regexCierre","includes","dataSource","ArrayIds","idFilters","filter","idRel","length"],"mappings":"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","sourcesContent":["import React, { useCallback, useContext, useEffect, useRef, useState } from 'react'\nimport { useHistory } from 'react-router-dom';\nimport pako from 'pako';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome'\nimport { faBars } from '@fortawesome/free-solid-svg-icons'\nimport Sidebar from '../../components/Sidebar'\nimport Modal from '../../components/Modal'\nimport { textEncode } from '../../helpers/helpers'\nimport { useSala } from '../../hooks/useSala';\nimport { apiDiagrama } from '../../api/apiDiagrama';\nimport socketContext from '../../context/socketContext';\nimport { useDiagrama } from '../../hooks/useDiagrama';\n\nconst BoardPage = () => {\n\n    const history = useHistory();\n    const { socket } = useContext(socketContext);\n    const [showbar, setShowbar] = useState(false);\n    const [typeModal, setTypeModal] = useState(\"load\");\n    const [typeDiagram, settypeDiagram] = useState(\"Container\");\n    const { executeDraw } = useDiagrama();\n    const { sala, error, isAnfitrion, validate } = useSala();\n\n    //Save DB\n    const [sourceDiagram, setsourceDiagram] = useState(\"\");\n    const [sourceRel, setSourceRel] = useState([]);\n\n    const refImage = useRef();\n\n    const HandleTypeModal = (type) => {\n        setTypeModal(type);\n    }\n\n    const HandleTypeDiagram = (type) => {\n        settypeDiagram(type);\n    }\n\n    const FinalizarRoom = async () => {\n\n        const res = await apiDiagrama(`/sala/finalize/${sala._id}`);\n        if (!res.ok) {\n            console.log(\"Error no se pudo cerrar la sala\");\n            return;\n        }\n        // Finalizar sala\n        socket.emit(\"finalizar-sala\", { idSala: sala._id });\n        history.replace('/');\n    }\n\n    //Button Dowload\n    const HandleClickDowload = () => {\n        try {\n            fetch(refImage.current.src)\n                .then(resp => resp.blob())\n                .then(blob => {\n                    const url = window.URL.createObjectURL(blob);\n                    const a = document.createElement('a');\n                    a.style.display = 'none';\n                    a.href = url;\n                    a.download = \"DiagramaC4\";\n                    document.body.appendChild(a);\n                    a.click();\n                    window.URL.revokeObjectURL(url);\n                });\n\n        } catch (errr) {\n            alert(\"Nose pudo descargar la imagen!!!\");\n        }\n    }\n\n    //Button Borrar\n    const HandleBorraBoard = () => {\n        setsourceDiagram(\"\");\n        setSourceRel([]);\n        DrawDiagram();\n        socket.emit(\"borrar-board\", { idSala: sala._id });\n    }\n\n    const DrawDiagram = useCallback((element = \"\", SystemBoundary = null) => {\n\n        let source = `@startuml\\n!include C4_${typeDiagram}.puml\\n`;\n\n        if (SystemBoundary) {\n\n            const { id, title } = SystemBoundary;\n\n            setsourceDiagram((sourceD) => {\n\n                let DrawSystem_Boundary = `System_Boundary(${id},\"${title}\"){\\n` + sourceD + `}\\n`;\n                source += DrawSystem_Boundary;\n                source += \"@enduml\";\n\n                let data = textEncode(source);\n                let compressed = pako.deflate(data, { level: 9, to: 'string' });\n                let result = btoa(compressed).replace(/\\+/g, '-').replace(/\\//g, '_');\n                refImage.current.src = `https://kroki.io/plantuml/svg/${result}`;\n\n                return DrawSystem_Boundary;\n            })\n\n            return;\n        }\n\n\n        setsourceDiagram((sourceD) => {\n\n            source += sourceD;\n            source += element;\n\n            source += \"@enduml\";\n\n            let data = textEncode(source);\n            let compressed = pako.deflate(data, { level: 9, to: 'string' });\n            let result = btoa(compressed).replace(/\\+/g, '-').replace(/\\//g, '_');\n            refImage.current.src = `https://kroki.io/plantuml/svg/${result}`;\n\n            return sourceD + element\n        });\n\n    }, [typeDiagram]);\n\n    // Save Data Board\n    const HandleSaveBoard = async () => {\n        const res = await apiDiagrama(`/sala/setData/${sala._id}`, \"POST\", { board: sourceDiagram, links: sourceRel });\n        if (!res.ok) {\n            alert(\"No se pudo guardar la data !!!\");\n            return;\n        }\n        alert(\"Se guardo los datos de la pizarra !!!\")\n    }\n\n\n    // Solicitud Anfitrion [On]\n    useEffect(() => {\n\n        socket.on('solicitud-anfitrion', (args) => {\n            const { idUser, message, idSala } = args;\n            if (window.confirm(message)) {\n                socket.emit('solicitud-aceptada', { idUser, idSala });\n            } else {\n                socket.emit('solicitud-denegada', { idUser, idSala });\n            }\n        });\n\n        return () => {\n            socket.removeAllListeners(\"solicitud-anfitrion\");\n        }\n\n    }, [socket])\n\n\n    // Agregar ala sala join para que escuchen events [emit]\n    useEffect(() => {\n\n        (sala) && socket.emit('agregar-sala', { idSala: sala._id })\n\n    }, [socket, sala]);\n\n\n    //Close Sala [On]\n    useEffect(() => {\n\n        socket.on('close-sala', (args) => {\n            socket.emit('leave-sala', args);\n            history.replace(\"/\");\n        });\n\n        return () => {\n            socket.removeAllListeners(\"close-sala\");\n        }\n\n    }, [socket, history]);\n\n\n    //Borrar Board [On]\n    useEffect(() => {\n\n        socket.on(\"borrar-board-client\", () => {\n            setsourceDiagram(\"\");\n            setSourceRel([]);\n            DrawDiagram();\n        });\n\n        return () => {\n            socket.removeAllListeners(\"borrar-board-client\");\n        }\n\n    }, [socket, DrawDiagram]);\n\n    // Draw Figure [On]\n\n    useEffect(() => {\n\n        socket.on(\"draw-figure-sala\", (args) => {\n\n            // params[0] :id\n            const { element, params, idElement } = args;\n\n            if (idElement) {\n                setSourceRel((rel) => [...rel, idElement]);\n            }\n\n            if (element === \"DrawSystemBoundary\") {\n                const [id, title] = params;\n                DrawDiagram(\"\", { id, title });\n                return;\n            }\n\n            DrawDiagram(executeDraw(element, params));\n\n        });\n\n        return () => {\n            socket.removeAllListeners(\"draw-figure-sala\");\n        }\n\n    }, [socket, executeDraw, DrawDiagram]);\n\n\n    // Ejecuta cuado se cambia typeDiagram\n    // Se carga los datos guardados de la sala \n\n    useEffect(() => {\n\n        if (sala && refImage.current) {\n            setsourceDiagram(sala.board);\n            setSourceRel(sala.links);\n            DrawDiagram();\n        }\n\n    }, [sala, DrawDiagram]);\n\n    // Eliminar element [On]\n\n    useEffect(() => {\n\n        socket.on(\"eliminar-element-client\", (args) => {\n\n            const { idElement } = args;\n\n            let regexFind = new RegExp(`\\\\S*${idElement}\\\\S*\\n`, \"gi\");\n            let regexCierre = new RegExp(`}\\n`, \"gi\");\n\n            if (idElement.includes('limit')) {\n\n                setsourceDiagram((dataSource) => {\n\n                    let res = dataSource.replace(regexFind, \"\");\n                    res = res.replace(regexCierre, \"\")\n                    return res;\n\n                });\n\n            } else {\n\n                setsourceDiagram((dataSource) => {\n\n                    let res = dataSource.replace(regexFind, \"\");\n                    return res;\n\n                });\n\n            }\n\n            // Eliminando id \n            setSourceRel((ArrayIds) => {\n                let idFilters = ArrayIds.filter((idRel) => idRel !== idElement);\n                return idFilters;\n            });\n\n            // Params por Defecto\n            DrawDiagram();\n\n        })\n\n        return () => {\n            socket.removeAllListeners(\"eliminar-element-client\");\n        }\n\n    }, [socket, DrawDiagram]);\n\n    if (validate) {\n        return <h5 className='text-center'>Cargando !!!</h5>\n    }\n\n    if (error.length > 0) {\n        return <h5 className='text-center'>{error}</h5>\n    }\n\n    return (\n\n        <>\n            <Sidebar\n                show={showbar}\n                HandleTypeModal={HandleTypeModal}\n                HandleTypeDiagram={HandleTypeDiagram}\n            />\n\n            <div className='container-fluid'>\n\n                <header className='row border'>\n                    <div className='col-md-11'>\n                        <h2 className='text-center'>C4 Diagramas</h2>\n                    </div>\n                    <div className='col-md-1 text-center my-auto'>\n                        <FontAwesomeIcon\n                            icon={faBars}\n                            className='pointer'\n                            onClick={() => setShowbar(!showbar)}\n                        />\n                    </div>\n                </header>\n\n                <section className='row mt-3'>\n\n                    <div className='col-12 col-md-10 mx-auto shadow board text-center'>\n                        <img ref={refImage} src={\"x\"} alt={\"C4 diagramas\"} className={(sourceRel.length) > 2 ? \"h-100\" : \"\"} />\n                    </div>\n\n                    <div className='col-12 col-md-10 mx-auto p-2'>\n                        {\n                            (isAnfitrion)\n                                ?\n                                <>\n                                    <button onClick={HandleSaveBoard} className='btn btn-primary mx-1'>Guardar</button>\n                                    <button onClick={HandleBorraBoard} className='btn btn-danger mx-1'>Borrar</button>\n                                    <button onClick={HandleClickDowload} className='btn btn-success mx-1'>Imprimir</button>\n                                    <button onClick={FinalizarRoom} className='btn btn-dark mx-1'>Finalizar reunion</button>\n                                </>\n                                : <button onClick={HandleClickDowload} className='btn btn-success mx-1'>Imprimir</button>\n                        }\n                    </div>\n\n                </section>\n\n                <Modal type={typeModal} DrawDiagram={DrawDiagram} setSourceRel={setSourceRel} sourceRel={sourceRel} setsourceDiagram={setsourceDiagram} />\n\n            </div>\n        </>\n    )\n}\n\nexport default BoardPage\n"]},"metadata":{},"sourceType":"module"}